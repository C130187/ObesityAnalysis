---
title: "Temp"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r}

gbar <- ggplot(brfs_national_income_year,aes(x=YearStart,n))+
  geom_col() +
  facet_wrap(~Class) + 
  geom_text(aes(label=n),vjust=-1.5, position = position_dodge(width = 1),size=3)+
  ylab("Number of rows") + 
  ggtitle("Number of rows belonging to Unknown Income Stratification level, faceted by Class")

plot(gbar)

```

```{r}

library(vcd)
library(forcats)

brfs_national_income_obesity <- brfs_national_income %>% filter(Class == "Obesity / Weight Status" & QuestionRenamed=="Obese")

brfs_national_income_obesity_mosaic <-  brfs_national_income_obesity %>% select(YearStart,Stratification1,Data_Value) %>% rename(Freq = Data_Value,
 Income = Stratification1) 

brfs_national_income_obesity_mosaic$Income <- as.factor(brfs_national_income_obesity_mosaic$Income)
brfs_national_income_obesity_mosaic$Income <- relevel(brfs_national_income_obesity_mosaic$Income,"Less than $15,000")

vcd::mosaic(Income~YearStart, 
            brfs_national_income_obesity_mosaic,
            direction=c("v","h"),
            labeling = labeling_values)

```

```{r}

# brfs_national_income <- brfs_national %>% filter(StratificationCategory1=="Income")
# 
# brfs_national_income_year <- brfs_national_income %>% filter(Total!="Total" & Income=="Data not reported") %>% group_by(YearStart, Class) %>%
#   summarise(n = n())
# 
# 
# library(extracat)

brfs_national2 <- brfs_national
brfs_national2[ brfs_national2 == "Data not reported" ] <- NA

# Missing values
visna(brfs_national2)

```
```{r}

g_ts_income_obesity <- ggplot(brfs_national_income_obesity_mosaic, aes(y=Freq, x=YearStart))+geom_point(aes(colour = Income, group = Income))+geom_line(aes(colour = Income, group = Income)) 
plot(g_ts_income_obesity)
# chaneg Freq to percentage of adults


```
``` {r}
brfs_national_age_obesity <- brfs_national %>% filter(StratificationCategory1=="Age (years)" & Class == "Obesity / Weight Status" & QuestionRenamed=="Obese")

brfs_national_age_obesity_filtered <-  brfs_national_age_obesity %>% select(YearStart,Stratification1,Data_Value) %>%
  rename(Age_Group = Stratification1)

brfs_national_age_obesity_filtered$Age_Group <- as.factor(brfs_national_age_obesity_filtered$Age_Group)

g_ts_age_obesity <- ggplot(brfs_national_age_obesity_filtered, aes(y=Data_Value, x=YearStart))+geom_point(aes(colour = Age_Group, group = Age_Group))+geom_line(aes(colour = Age_Group, group = Age_Group)) 
plot(g_ts_age_obesity)

```
``` {r}

library(directlabels)

brfs_national_obesity <- brfs_national %>% filter(Class == "Obesity / Weight Status" & QuestionRenamed=="Obese")

brfs_national_obesity_filtered <-brfs_national_obesity %>% select(YearStart,StratificationCategory1,Stratification1,Data_Value)

brfs_national_obesity_filtered$StratificationCategory1 <- as.factor(brfs_national_obesity_filtered$StratificationCategory1)

brfs_national_obesity_filtered$Stratification1 <- as.factor(brfs_national_obesity_filtered$Stratification1)

brfs_national_obesity_filtered$Stratification1 <- relevel(brfs_national_obesity_filtered$Stratification1,"Less than $15,000")

brfs_national_obesity_filtered$Stratification1 <- fct_relevel(brfs_national_obesity_filtered$Stratification1, "Less than high school", after = 1)

brfs_national_obesity_filtered$Stratification1 <- fct_relevel(brfs_national_obesity_filtered$Stratification1, "College graduate", after = Inf)

brfs_national_obesity_filtered <- brfs_national_obesity_filtered %>% rename(Stratification=Stratification1)

# make list of plots
ggList <- lapply(split(brfs_national_obesity_filtered, brfs_national_obesity_filtered$StratificationCategory1), function(i) {
  ggplot(i, aes(y=Data_Value, x=YearStart))+geom_point(aes(colour = Stratification, group = Stratification))+geom_line(aes(colour = Stratification, group = Stratification))}) 

# plot as grid in 1 columns
cowplot::plot_grid(plotlist = ggList, ncol = 2,
                   align = 'v', labels = levels(brfs_national_obesity_filtered$StratificationCategory1))

```

Race
``` {r}

# Filter for race data

brfs_2019_race <-brfs_2019_filtered %>%
  filter(StratificationCategory1=="Race/Ethnicity") %>%
  group_by(Class2,Stratification1) %>%
  summarise(mean_data_value = mean(Data_Value))
# %>%
#   ungroup() %>%
#   group_by(Class) %>%
#   arrange(desc(mean_data_value), .by_group = TRUE)


brfs_2019_race.mean = brfs_2019_race %>%
  group_by(Class2) %>%
  mutate(ymean = mean(mean_data_value))

cols <- c("Class Average %"="red")

barplot <-  ggplot(brfs_2019_race,aes(x=Stratification1, y=mean_data_value))+
  geom_col()+geom_text(aes(label=mean_data_value),vjust = -1.5, position = position_dodge(width = 1),size=3)+
  geom_errorbar(data=brfs_2019_race.mean, aes(x=Stratification1, ymax = ymean, ymin = ymean, colour="Class Average %"),
               size=0.5, linetype = "longdash", inherit.aes = F, width = 1)+
  scale_colour_manual(name="Dotted Line",values=cols)+ scale_fill_manual(name="Bar",values=cols) +
  facet_wrap(~Class2, ncol = 1) + ylim(c(0,100))+
  ylab("Percentage") +
  ggtitle("Percentage across different Race/Ethnicity Groups in 2019")

plot(barplot)

# For Asians, the obesity status is the least.
# The levels of lack of fruit/vegetable consumption and lack of physical activity are not that much higher for Hawaiian/Pacific Island people even though their obesity status is the highest. This could be due to genetic or other factors, not captured in the available data.
# For 2 or more races, American Indian/Alaska Native, Non-Hispanic black -> they have less nutrition and physical activity than others, and also high obesity status.

```

``` {r}

brfs_2019_gender <-brfs_2019_filtered %>%
  filter(StratificationCategory1=="Gender") %>%
  group_by(Class2,Stratification1) %>%
  summarise(mean_data_value = mean(Data_Value))

brfs_2019_gender.mean = brfs_2019_gender %>%
  group_by(Class2) %>%
  mutate(ymean = mean(mean_data_value))

barplot <-  ggplot(brfs_2019_gender,aes(x=Stratification1, y=mean_data_value))+
  geom_col()+geom_text(aes(label=mean_data_value),vjust = -1.5, position = position_dodge(width = 1),size=3)+
  geom_errorbar(data=brfs_2019_gender.mean, aes(x=Stratification1, ymax = ymean, ymin = ymean, colour="Class Average %"),
               size=0.5, linetype = "longdash", inherit.aes = F, width = 1)+
  scale_colour_manual(name="Dotted Line",values=cols)+ scale_fill_manual(name="Bar",values=cols) +
  facet_wrap(~Class2, ncol = 1) + ylim(c(0,100))+
  ylab("Percentage") +
  ggtitle("Percentage split by Gender in 2019")

plot(barplot)

# No noticeable trend

# pe_2018_yesnoq_wider_pivot$state <- pe_2018_yesnoq_wider_pivot$LocationAbbr
#
# statebins(pe_2018_yesnoq, value_col="n_policies", name = "n_policies") +
#   theme_statebins(legend_position="right")

```

```{r}

sb1_overall <- ggplot(pe_2018_yesnoq, aes(state=state, fill=n_policies)) +
        geom_statebins() +
        coord_equal() +
        viridis::scale_fill_viridis(
        name = "Number of policies ", limits=c(0,5), breaks=0:5, option = "magma", direction = -1
        ) +
        labs(title="Total Number of policies for good Nutrition, Physicial Activity and Television Viewing ") +
        #theme_statebins(base_family = font_ps) +
        theme(plot.title=element_text(size=16, hjust=0)) +
        theme(plot.margin = margin(30,30,30,30))

plot(sb1_overall)

```
